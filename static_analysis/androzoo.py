import pandas as pd
import os
import requests


API = "static_analysis/api_key.txt"
LATEST = "static_analysis/sample.csv"
APKS = "static_analysis/apks"

def read_apikey(file):
    with open(file, 'r') as f:
        lines = f.readlines()
    return lines[0]

def choose_sha(file):
    csv = pd.read_csv(file)
    already_dl = pd.Series(os.listdir(APKS))
    already_dl = already_dl.str.split('.')[0]
    csv = csv[~csv.sha256.isin(already_dl)]
    return csv.sample(1)['sha256'].values[0]



if __name__ == "__main__":
    key = read_apikey(API)
    sha = choose_sha(LATEST)
    params = (
        ('apikey', key),
        ('sha256', sha),
    )

    response = requests.get('https://androzoo.uni.lu/api/download', params=params)
    filename = response.headers['Content-Disposition'].split('=')[-1]
    with open(os.path.join(APKS,filename), 'wb') as f:
        f.write(response.content)
    print(f"Downloaded apk {sha}")
    #response = requests.get('https://androzoo.uni.lu/api/download?apikey=${APIKEY}&sha256=${SHA256}')